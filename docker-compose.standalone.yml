# Standalone ALPR Service - PanoramaCity Integration
# Use this for production deployment with API mode (default) or FTP mode (legacy)
#
# Usage:
#   docker-compose -f docker-compose.standalone.yml up -d --build
#
# Note: Requires NVIDIA runtime as default. Check with:
#   docker info | grep -i runtime
# If not default, add to /etc/docker/daemon.json:
#   {"default-runtime": "nvidia", "runtimes": {"nvidia": {"path": "nvidia-container-runtime", "runtimeArgs": []}}}

version: '2.3'

services:
  alpr-service:
    build:
      context: .
      dockerfile: Dockerfile.production
    image: alpr-service:latest
    container_name: alpr-service
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # Service mode: 'api' (PanoramaCity) or 'ftp' (legacy)
      - ALPR_MODE=${ALPR_MODE:-api}

      # Watch directories (inside container)
      - ALPR_WATCH_DIR=/watch/inbox
      - ALPR_OUTPUT_DIR=/watch/outbox

      # PanoramaCity API settings
      - ALPR_API_URL=${ALPR_API_URL:-https://acces.panoramacity.ro/utilitypagesAPI/_x_ApI_nano.php}
      - ALPR_API_KEY=${ALPR_API_KEY:-A954C6A5-5207-4DF8-91BC-E9E3B73664BF}
      - ALPR_CACHE_TTL=${ALPR_CACHE_TTL:-3600}
      - ALPR_JPEG_QUALITY=${ALPR_JPEG_QUALITY:-70}

      # Gate control
      - ALPR_GATE_ENABLED=${ALPR_GATE_ENABLED:-false}
      - ALPR_GATE1_IP=${ALPR_GATE1_IP:-192.168.1.230}
      - ALPR_GATE2_IP=${ALPR_GATE2_IP:-192.168.1.234}

      # FTP settings (legacy mode)
      - ALPR_FTP_HOST=${ALPR_FTP_HOST:-192.168.100.238}
      - ALPR_FTP_USER=${ALPR_FTP_USER:-photo}
      - ALPR_FTP_PASS=${ALPR_FTP_PASS:-photo}
      - ALPR_FTP_DIR=${ALPR_FTP_DIR:-/}

      # Detection settings
      - ALPR_CONF_THRESH=${ALPR_CONF_THRESH:-0.4}
      - ALPR_DELETE_PROCESSED=${ALPR_DELETE_PROCESSED:-true}

      # Test mode (detection only, no API calls)
      - ALPR_TEST_MODE=${ALPR_TEST_MODE:-false}
      - ALPR_PREVIEW_PORT=${ALPR_PREVIEW_PORT:-8080}

      # Enhanced detection (requires yolov8n.onnx model)
      - ALPR_ENHANCED_DETECTION=${ALPR_ENHANCED_DETECTION:-false}
      - ALPR_MIN_PLATE_SIZE=${ALPR_MIN_PLATE_SIZE:-30}

      # Crop margins for enhanced detection (0.0-0.5)
      - ALPR_ENHANCED_CROP_LEFT=${ALPR_ENHANCED_CROP_LEFT:-0.0}
      - ALPR_ENHANCED_CROP_RIGHT=${ALPR_ENHANCED_CROP_RIGHT:-0.0}
      - ALPR_ENHANCED_CROP_TOP=${ALPR_ENHANCED_CROP_TOP:-0.0}
      - ALPR_ENHANCED_CROP_BOTTOM=${ALPR_ENHANCED_CROP_BOTTOM:-0.0}
    ports:
      - "${ALPR_PREVIEW_PORT:-8080}:8080"
    volumes:
      # Use /dev/shm for RAM-based storage (protects SD card)
      - /dev/shm/alpr_inbox:/watch/inbox
      - /dev/shm/alpr_outbox:/watch/outbox
      # Models (read-only)
      - ./models:/app/models:ro
      # TensorRT engine cache (persistent for faster startup)
      - tensorrt_cache:/cache/tensorrt

volumes:
  tensorrt_cache:
