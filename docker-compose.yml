# Docker Compose for Production ALPR Service
# Includes FTP server for camera uploads and ALPR processing service
#
# Usage:
#   docker-compose up -d
#
# Camera FTP settings:
#   Host: <jetson-ip>
#   Port: 21
#   User: camera
#   Pass: camera123
#   Path: /

version: '2.3'

services:
  # FTP Server for receiving camera uploads
  # Images go to /dev/shm/ftp_inbox (RAM disk)
  ftp-server:
    image: fauria/vsftpd
    container_name: alpr-ftp-server
    restart: unless-stopped
    ports:
      - "21:21"
      - "21100-21110:21100-21110"
    environment:
      - FTP_USER=camera
      - FTP_PASS=camera123
      - PASV_ADDRESS=${JETSON_IP:-10.8.1.2}
      - PASV_MIN_PORT=21100
      - PASV_MAX_PORT=21110
      - LOCAL_UMASK=022
    volumes:
      - /dev/shm/ftp_inbox:/home/vsftpd/camera
    networks:
      - alpr-network

  # ALPR Processing Service
  alpr-service:
    build:
      context: .
      dockerfile: Dockerfile.production
    image: alpr-service:latest
    container_name: alpr-service
    restart: unless-stopped
    runtime: nvidia
    environment:
      - ALPR_WATCH_DIR=/watch/inbox
      - ALPR_OUTPUT_DIR=/watch/outbox
      - ALPR_FTP_HOST=${ALPR_FTP_HOST:-192.168.100.238}
      - ALPR_FTP_USER=${ALPR_FTP_USER:-photo}
      - ALPR_FTP_PASS=${ALPR_FTP_PASS:-photo}
      - ALPR_FTP_DIR=${ALPR_FTP_DIR:-/}
      - ALPR_CONF_THRESH=${ALPR_CONF_THRESH:-0.4}
      - ALPR_DELETE_PROCESSED=true
      - ALPR_LOG_LEVEL=${ALPR_LOG_LEVEL:-INFO}
    volumes:
      # Watch the FTP inbox (host RAM-based directory)
      - /dev/shm/ftp_inbox:/watch/inbox
      # Temp output (host RAM-based directory)
      - /dev/shm/alpr_outbox:/watch/outbox
      # Models (read-only)
      - ./models:/app/models:ro
    depends_on:
      - ftp-server
    networks:
      - alpr-network

networks:
  alpr-network:
    driver: bridge
