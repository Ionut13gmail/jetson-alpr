# Production Dockerfile for ALPR Service on Jetson Nano
# PanoramaCity Integration - GPU-accelerated license plate recognition
#
# Features:
# - Watches for camera uploads via FTP
# - GPU-accelerated ALPR with TensorRT
# - Plate authorization against remote database
# - Gate barrier control
# - Async cloud upload

FROM dustynv/l4t-ml:r32.7.1

WORKDIR /app

# Install dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3-pip \
    && rm -rf /var/lib/apt/lists/* \
    && pip3 install --no-cache-dir inotify requests

# Copy application files
COPY jetson_alpr.py /app/
COPY alpr_service.py /app/
COPY plate_api.py /app/
COPY models/ /app/models/

# Create watch directories (will be mounted from host)
RUN mkdir -p /watch/inbox /watch/outbox

# Environment variables - Service Mode
ENV ALPR_MODE=api

# Watch directories
ENV ALPR_WATCH_DIR=/watch/inbox
ENV ALPR_OUTPUT_DIR=/watch/outbox

# API settings (PanoramaCity)
ENV ALPR_API_URL=https://acces.panoramacity.ro/utilitypagesAPI/_x_ApI_nano.php
ENV ALPR_API_KEY=A954C6A5-5207-4DF8-91BC-E9E3B73664BF
ENV ALPR_CACHE_TTL=3600
ENV ALPR_JPEG_QUALITY=70

# Gate control
ENV ALPR_GATE_ENABLED=false
ENV ALPR_GATE1_IP=192.168.1.230
ENV ALPR_GATE2_IP=192.168.1.234

# FTP settings (legacy mode)
ENV ALPR_FTP_HOST=192.168.100.238
ENV ALPR_FTP_USER=photo
ENV ALPR_FTP_PASS=photo
ENV ALPR_FTP_DIR=/

# Detection settings
ENV ALPR_CONF_THRESH=0.4
ENV ALPR_DELETE_PROCESSED=true
ENV ALPR_LOG_LEVEL=INFO

# Enhanced detection (for distant plates) - requires vehicle model
# Disabled by default as yolov8n.onnx is not included
ENV ALPR_ENHANCED_DETECTION=false
ENV ALPR_MIN_PLATE_SIZE=30
ENV ALPR_VEHICLE_CONF_THRESH=0.3

# Crop margins for enhanced detection (0.0-0.5)
# Use when car is centered and you want to exclude edges
ENV ALPR_ENHANCED_CROP_LEFT=0.0
ENV ALPR_ENHANCED_CROP_RIGHT=0.0
ENV ALPR_ENHANCED_CROP_TOP=0.0
ENV ALPR_ENHANCED_CROP_BOTTOM=0.0

# TensorRT engine cache (mount a persistent volume for faster startup)
# First inference builds TensorRT engines which takes 1-3 minutes
# Subsequent starts use cached engines for instant startup
ENV ORT_TENSORRT_ENGINE_CACHE_ENABLE=1
ENV ORT_TENSORRT_CACHE_PATH=/cache/tensorrt
RUN mkdir -p /cache/tensorrt && chmod 777 /cache/tensorrt

# Test mode - detection only, no API calls (for calibration)
ENV ALPR_TEST_MODE=false

# Live preview server port (test mode)
ENV ALPR_PREVIEW_PORT=8080
EXPOSE 8080

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD python3 -c "import os; exit(0 if os.path.exists('/app/models') else 1)"

# Run the service
CMD ["python3", "-u", "/app/alpr_service.py"]
